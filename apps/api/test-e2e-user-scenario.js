/**
 * End-to-End User Scenario Test
 * Generated by Kiro - HauntedAI Platform
 * 
 * This test simulates a complete user journey through the HauntedAI platform:
 * 1. User authentication
 * 2. Create a new room
 * 3. Start workflow
 * 4. Monitor live logs via SSE
 * 5. Verify room status updates
 */

const http = require('http');
const https = require('https');

const API_BASE_URL = process.env.API_URL || 'http://localhost:3001';
const TEST_USER_ID = 'test-user-' + Date.now();

// Colors for console output
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function makeRequest(method, path, data = null) {
  return new Promise((resolve, reject) => {
    const url = new URL(path, API_BASE_URL);
    const options = {
      method,
      headers: {
        'Content-Type': 'application/json',
      },
    };

    const client = url.protocol === 'https:' ? https : http;

    const req = client.request(url, options, (res) => {
      let body = '';
      res.on('data', (chunk) => (body += chunk));
      res.on('end', () => {
        try {
          const response = body ? JSON.parse(body) : {};
          resolve({ status: res.statusCode, data: response, headers: res.headers });
        } catch (e) {
          resolve({ status: res.statusCode, data: body, headers: res.headers });
        }
      });
    });

    req.on('error', reject);

    if (data) {
      req.write(JSON.stringify(data));
    }

    req.end();
  });
}

function connectSSE(roomId) {
  return new Promise((resolve, reject) => {
    const url = new URL(`/api/v1/rooms/${roomId}/logs`, API_BASE_URL);
    const client = url.protocol === 'https:' ? https : http;

    const req = client.request(url, { method: 'GET' }, (res) => {
      if (res.statusCode !== 200) {
        reject(new Error(`SSE connection failed: ${res.statusCode}`));
        return;
      }

      log('‚úì SSE connection established', 'green');

      const logs = [];
      let buffer = '';

      res.on('data', (chunk) => {
        buffer += chunk.toString();
        const lines = buffer.split('\n\n');
        buffer = lines.pop() || '';

        lines.forEach((line) => {
          if (line.startsWith('event:')) {
            const eventMatch = line.match(/event: (\w+)/);
            const dataMatch = line.match(/data: (.+)/);

            if (eventMatch && dataMatch) {
              const event = eventMatch[1];
              const data = JSON.parse(dataMatch[1]);

              if (event === 'log') {
                logs.push(data);
                log(`  [${data.level.toUpperCase()}] ${data.agentType}: ${data.message}`, 'cyan');
              } else if (event === 'connected') {
                log(`  Connected to room: ${data.roomId}`, 'blue');
              } else if (event === 'heartbeat') {
                log(`  ‚ô• Heartbeat`, 'yellow');
              }
            }
          }
        });
      });

      res.on('end', () => {
        resolve(logs);
      });

      // Close connection after 5 seconds
      setTimeout(() => {
        req.destroy();
        resolve(logs);
      }, 5000);
    });

    req.on('error', reject);
    req.end();
  });
}

async function runUserScenario() {
  log('\nüéÉ HauntedAI - End-to-End User Scenario Test üéÉ\n', 'yellow');
  log('=' .repeat(60), 'yellow');

  try {
    // Step 1: Health Check
    log('\nüìã Step 1: Health Check', 'blue');
    const health = await makeRequest('GET', '/health');
    if (health.status === 200) {
      log('‚úì API is healthy', 'green');
    } else {
      throw new Error('API health check failed');
    }

    // Step 2: Create a new room
    log('\nüìã Step 2: Create New Room', 'blue');
    const createRoomData = {
      userId: TEST_USER_ID,
      inputText: 'Tell me a spooky story about a haunted mansion',
    };

    const createResponse = await makeRequest('POST', '/api/v1/rooms', createRoomData);
    
    if (createResponse.status === 201 || createResponse.status === 200) {
      log('‚úì Room created successfully', 'green');
      log(`  Room ID: ${createResponse.data.id}`, 'cyan');
      log(`  Status: ${createResponse.data.status}`, 'cyan');
      log(`  Input: ${createResponse.data.inputText}`, 'cyan');
    } else {
      throw new Error(`Failed to create room: ${createResponse.status}`);
    }

    const roomId = createResponse.data.id;

    // Step 3: Get room details
    log('\nüìã Step 3: Get Room Details', 'blue');
    const roomDetails = await makeRequest('GET', `/api/v1/rooms/${roomId}`);
    
    if (roomDetails.status === 200) {
      log('‚úì Room details retrieved', 'green');
      log(`  Owner: ${roomDetails.data.owner?.username || 'N/A'}`, 'cyan');
      log(`  Created: ${roomDetails.data.createdAt}`, 'cyan');
    }

    // Step 4: Start workflow
    log('\nüìã Step 4: Start Workflow', 'blue');
    const startWorkflow = await makeRequest('POST', `/api/v1/rooms/${roomId}/start`);
    
    if (startWorkflow.status === 200) {
      log('‚úì Workflow started', 'green');
      log(`  Status: ${startWorkflow.data.status}`, 'cyan');
      log(`  Message: ${startWorkflow.data.message}`, 'cyan');
    }

    // Step 5: Connect to SSE and monitor logs
    log('\nüìã Step 5: Monitor Live Logs (SSE)', 'blue');
    log('Connecting to SSE stream...', 'yellow');
    
    const logs = await connectSSE(roomId);
    
    log(`\n‚úì Received ${logs.length} log messages`, 'green');

    // Step 6: Verify room status after workflow
    log('\nüìã Step 6: Verify Final Room Status', 'blue');
    const finalRoom = await makeRequest('GET', `/api/v1/rooms/${roomId}`);
    
    if (finalRoom.status === 200) {
      log('‚úì Final room status retrieved', 'green');
      log(`  Status: ${finalRoom.data.status}`, 'cyan');
      log(`  Assets: ${finalRoom.data.assets?.length || 0}`, 'cyan');
    }

    // Summary
    log('\n' + '='.repeat(60), 'yellow');
    log('üéâ User Scenario Test Completed Successfully! üéâ', 'green');
    log('=' .repeat(60), 'yellow');
    log('\nTest Summary:', 'blue');
    log(`  ‚úì Room created: ${roomId}`, 'green');
    log(`  ‚úì Workflow started`, 'green');
    log(`  ‚úì SSE connection established`, 'green');
    log(`  ‚úì Logs received: ${logs.length}`, 'green');
    log(`  ‚úì All steps passed`, 'green');

    return {
      success: true,
      roomId,
      logsReceived: logs.length,
    };

  } catch (error) {
    log('\n‚ùå Test Failed!', 'red');
    log(`Error: ${error.message}`, 'red');
    if (error.stack) {
      log(error.stack, 'red');
    }
    return {
      success: false,
      error: error.message,
    };
  }
}

// Run the test
if (require.main === module) {
  runUserScenario()
    .then((result) => {
      process.exit(result.success ? 0 : 1);
    })
    .catch((error) => {
      log(`\n‚ùå Unexpected error: ${error.message}`, 'red');
      process.exit(1);
    });
}

module.exports = { runUserScenario };
