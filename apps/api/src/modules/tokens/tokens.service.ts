// Generated by Kiro
import { Injectable, NotFoundException } from '@nestjs/common';

import { PrismaService } from '../../prisma/prisma.service';

@Injectable()
export class TokensService {
  constructor(private prisma: PrismaService) {}

  /**
   * Get user token balance
   * Requirements: 9.5
   */
  async getBalance(userDid: string) {
    const user = await this.prisma.user.findUnique({
      where: { did: userDid },
    });

    if (!user) {
      throw new NotFoundException(`User with DID ${userDid} not found`);
    }

    const transactions = await this.prisma.tokenTransaction.findMany({
      where: { userId: user.id },
    });

    const balance = transactions.reduce((sum, tx) => sum + Number(tx.amount), 0);

    return {
      userId: user.id,
      did: user.did,
      username: user.username,
      balance,
      transactionCount: transactions.length,
    };
  }

  /**
   * Get user transaction history
   * Requirements: 9.4
   */
  async getTransactions(userDid: string, limit = 50, offset = 0) {
    const user = await this.prisma.user.findUnique({
      where: { did: userDid },
    });

    if (!user) {
      throw new NotFoundException(`User with DID ${userDid} not found`);
    }

    const transactions = await this.prisma.tokenTransaction.findMany({
      where: { userId: user.id },
      orderBy: { createdAt: 'desc' },
      take: limit,
      skip: offset,
    });

    return transactions;
  }

  /**
   * Reward user with tokens (internal use)
   * Requirements: 9.1, 9.2, 9.3
   */
  async rewardUser(userId: string, amount: number, reason: string, txHash?: string) {
    const transaction = await this.prisma.tokenTransaction.create({
      data: {
        userId,
        amount: BigInt(amount),
        reason,
        txHash,
      },
    });

    return transaction;
  }
}
