// Generated by Kiro
import { Injectable, NotFoundException, Inject, forwardRef } from '@nestjs/common';
import { RoomStatus } from '@prisma/client';

import { PrismaService } from '../../prisma/prisma.service';

import { CreateRoomDto } from './dto/create-room.dto';
import { RedisService } from './redis.service';
import { AgentLog } from './types/agent-log.types';

@Injectable()
export class RoomsService {
  constructor(
    private prisma: PrismaService,
    @Inject(forwardRef(() => RedisService))
    private redisService: RedisService,
  ) {}

  /**
   * Create a new room
   * Requirements: 8.1, 8.2
   */
  async create(createRoomDto: CreateRoomDto) {
    const room = await this.prisma.room.create({
      data: {
        ownerId: createRoomDto.userId,
        inputText: createRoomDto.inputText,
        status: RoomStatus.idle,
      },
      include: {
        owner: {
          select: {
            id: true,
            username: true,
            did: true,
          },
        },
      },
    });

    return room;
  }

  /**
   * Get room by ID
   * Requirements: 8.3
   */
  async findOne(id: string) {
    const room = await this.prisma.room.findUnique({
      where: { id },
      include: {
        owner: {
          select: {
            id: true,
            username: true,
            did: true,
          },
        },
        assets: {
          orderBy: {
            createdAt: 'asc',
          },
        },
      },
    });

    if (!room) {
      throw new NotFoundException(`Room with ID ${id} not found`);
    }

    return room;
  }

  /**
   * Get all rooms for a user
   * Requirements: 8.3
   */
  async findByUser(userId: string) {
    const rooms = await this.prisma.room.findMany({
      where: { ownerId: userId },
      include: {
        assets: {
          select: {
            id: true,
            agentType: true,
            cid: true,
            createdAt: true,
          },
        },
      },
      orderBy: {
        createdAt: 'desc',
      },
    });

    return rooms;
  }

  /**
   * Start agent workflow for a room
   * Requirements: 8.3
   */
  async startWorkflow(id: string) {
    // Check if room exists
    const room = await this.prisma.room.findUnique({
      where: { id },
    });

    if (!room) {
      throw new NotFoundException(`Room with ID ${id} not found`);
    }

    // Update room status to running
    const updatedRoom = await this.prisma.room.update({
      where: { id },
      data: {
        status: RoomStatus.running,
        updatedAt: new Date(),
      },
      include: {
        owner: {
          select: {
            id: true,
            username: true,
            did: true,
          },
        },
      },
    });

    // TODO: Trigger orchestrator service to start agent workflow
    // This will be implemented in Task 5 (Orchestrator Service)

    return {
      ...updatedRoom,
      message: 'Workflow started successfully',
    };
  }

  /**
   * Update room status
   * Requirements: 8.4, 8.5
   */
  async updateStatus(id: string, status: RoomStatus, errorMessage?: string) {
    const room = await this.prisma.room.findUnique({
      where: { id },
    });

    if (!room) {
      throw new NotFoundException(`Room with ID ${id} not found`);
    }

    const updatedRoom = await this.prisma.room.update({
      where: { id },
      data: {
        status,
        updatedAt: new Date(),
      },
    });

    return updatedRoom;
  }

  /**
   * Emit log message to room via Redis pub/sub
   * Requirements: 5.1
   */
  async emitLog(
    roomId: string,
    agentType: AgentLog['agentType'],
    level: AgentLog['level'],
    message: string,
    metadata?: Record<string, any>,
  ): Promise<void> {
    const log: AgentLog = {
      timestamp: new Date(),
      agentType,
      level,
      message,
      metadata,
    };

    await this.redisService.publishLog(roomId, log);
  }
}
