// Generated by Kiro
// Unit tests for SSE and Redis services
// Requirements: 5.1, 5.2

import { Test, TestingModule } from '@nestjs/testing';
import { Response } from 'express';

import { SSEService } from './sse.service';
import { RedisService } from './redis.service';
import { RoomsService } from './rooms.service';
import { PrismaService } from '../../prisma/prisma.service';

describe('RoomsService - SSE Integration', () => {
  let service: RoomsService;
  let redisService: RedisService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        RoomsService,
        {
          provide: PrismaService,
          useValue: {
            room: {
              findUnique: jest.fn(),
              create: jest.fn(),
              update: jest.fn(),
              findMany: jest.fn(),
            },
          },
        },
        {
          provide: RedisService,
          useValue: {
            publishLog: jest.fn().mockResolvedValue(undefined),
            subscribeToRoomLogs: jest.fn(),
          },
        },
      ],
    }).compile();

    service = module.get<RoomsService>(RoomsService);
    redisService = module.get<RedisService>(RedisService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  describe('emitLog', () => {
    it('should publish log to Redis', async () => {
      const roomId = 'test-room-123';
      const agentType = 'story';
      const level = 'info';
      const message = 'Test message';
      const metadata = { test: true };

      await service.emitLog(roomId, agentType, level, message, metadata);

      expect(redisService.publishLog).toHaveBeenCalledWith(
        roomId,
        expect.objectContaining({
          agentType,
          level,
          message,
          metadata,
          timestamp: expect.any(Date),
        }),
      );
    });

    it('should emit log without metadata', async () => {
      const roomId = 'test-room-123';
      const agentType = 'asset';
      const level = 'success';
      const message = 'Asset generated';

      await service.emitLog(roomId, agentType, level, message);

      expect(redisService.publishLog).toHaveBeenCalledWith(
        roomId,
        expect.objectContaining({
          agentType,
          level,
          message,
          timestamp: expect.any(Date),
        }),
      );
    });

    it('should handle different agent types', async () => {
      const roomId = 'test-room-123';
      const agentTypes = ['story', 'asset', 'code', 'deploy', 'orchestrator'] as const;

      for (const agentType of agentTypes) {
        await service.emitLog(roomId, agentType, 'info', `Testing ${agentType}`);
      }

      expect(redisService.publishLog).toHaveBeenCalledTimes(agentTypes.length);
    });

    it('should handle different log levels', async () => {
      const roomId = 'test-room-123';
      const levels = ['info', 'warn', 'error', 'success'] as const;

      for (const level of levels) {
        await service.emitLog(roomId, 'story', level, `Testing ${level}`);
      }

      expect(redisService.publishLog).toHaveBeenCalledTimes(levels.length);
    });
  });
});

describe('SSEService', () => {
  let service: SSEService;
  let redisService: RedisService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        SSEService,
        {
          provide: RedisService,
          useValue: {
            subscribeToRoomLogs: jest.fn().mockResolvedValue(async () => {}),
          },
        },
      ],
    }).compile();

    service = module.get<SSEService>(SSEService);
    redisService = module.get<RedisService>(RedisService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  it('should track active connections', () => {
    const count = service.getActiveConnectionCount();
    expect(count).toBeGreaterThanOrEqual(0);
  });

  it('should track room-specific connections', () => {
    const roomId = 'test-room-123';
    const count = service.getRoomConnectionCount(roomId);
    expect(count).toBeGreaterThanOrEqual(0);
  });

  describe('createConnection', () => {
    it('should set correct SSE headers', async () => {
      const roomId = 'test-room-123';
      const mockResponse = {
        setHeader: jest.fn(),
        write: jest.fn(),
        on: jest.fn(),
      } as unknown as Response;

      // Don't await - just trigger the connection
      service.createConnection(roomId, mockResponse);

      // Wait a bit for async operations
      await new Promise((resolve) => setTimeout(resolve, 100));

      expect(mockResponse.setHeader).toHaveBeenCalledWith('Content-Type', 'text/event-stream');
      expect(mockResponse.setHeader).toHaveBeenCalledWith('Cache-Control', 'no-cache');
      expect(mockResponse.setHeader).toHaveBeenCalledWith('Connection', 'keep-alive');
      expect(mockResponse.setHeader).toHaveBeenCalledWith('X-Accel-Buffering', 'no');
    });

    it('should send connected event', async () => {
      const roomId = 'test-room-123';
      const mockResponse = {
        setHeader: jest.fn(),
        write: jest.fn(),
        on: jest.fn(),
      } as unknown as Response;

      service.createConnection(roomId, mockResponse);

      await new Promise((resolve) => setTimeout(resolve, 100));

      expect(mockResponse.write).toHaveBeenCalledWith(expect.stringContaining('event: connected'));
      expect(mockResponse.write).toHaveBeenCalledWith(
        expect.stringContaining(`"roomId":"${roomId}"`),
      );
    });

    it('should subscribe to Redis channel', async () => {
      const roomId = 'test-room-123';
      const mockResponse = {
        setHeader: jest.fn(),
        write: jest.fn(),
        on: jest.fn(),
      } as unknown as Response;

      service.createConnection(roomId, mockResponse);

      await new Promise((resolve) => setTimeout(resolve, 100));

      expect(redisService.subscribeToRoomLogs).toHaveBeenCalledWith(
        roomId,
        expect.any(Function),
      );
    });
  });
});

describe('RedisService', () => {
  let service: RedisService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [RedisService],
    }).compile();

    service = module.get<RedisService>(RedisService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  it('should have publisher instance', () => {
    const publisher = service.getPublisher();
    expect(publisher).toBeDefined();
  });

  it('should have subscriber instance', () => {
    const subscriber = service.getSubscriber();
    expect(subscriber).toBeDefined();
  });

  // Note: Full integration tests require Redis to be running
  // These are structural tests only
});
