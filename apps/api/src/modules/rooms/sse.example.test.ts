// Generated by Kiro
// Example test for SSE functionality
// This demonstrates how to test the SSE implementation

import { Test, TestingModule } from '@nestjs/testing';
import { Response } from 'express';

import { SSEService } from './sse.service';
import { RedisService } from './redis.service';

describe('SSE Service Example Tests', () => {
  let sseService: SSEService;
  let redisService: RedisService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        SSEService,
        {
          provide: RedisService,
          useValue: {
            subscribeToRoomLogs: jest.fn(),
            publishLog: jest.fn(),
          },
        },
      ],
    }).compile();

    sseService = module.get<SSEService>(SSEService);
    redisService = module.get<RedisService>(RedisService);
  });

  it('should be defined', () => {
    expect(sseService).toBeDefined();
  });

  it('should track active connections', () => {
    const count = sseService.getActiveConnectionCount();
    expect(count).toBeGreaterThanOrEqual(0);
  });

  it('should track room-specific connections', () => {
    const roomId = 'test-room-id';
    const count = sseService.getRoomConnectionCount(roomId);
    expect(count).toBeGreaterThanOrEqual(0);
  });
});

describe('Redis Service Example Tests', () => {
  let redisService: RedisService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [RedisService],
    }).compile();

    redisService = module.get<RedisService>(RedisService);
  });

  it('should be defined', () => {
    expect(redisService).toBeDefined();
  });

  // Note: Full integration tests require Redis to be running
  // These are just structural tests
});

/**
 * Integration Test Example (requires Redis)
 * 
 * To run integration tests:
 * 1. Start Redis: docker-compose up redis
 * 2. Run: npm test -- sse.example.test.ts
 */
describe('SSE Integration Example (requires Redis)', () => {
  it.skip('should publish and receive log messages', async () => {
    // This test requires Redis to be running
    // Uncomment and modify when ready for integration testing
    
    /*
    const roomId = 'test-room-123';
    const testLog = {
      timestamp: new Date(),
      agentType: 'story' as const,
      level: 'info' as const,
      message: 'Test message',
    };

    // Subscribe to logs
    const receivedLogs: any[] = [];
    const unsubscribe = await redisService.subscribeToRoomLogs(
      roomId,
      (log) => {
        receivedLogs.push(log);
      }
    );

    // Publish a log
    await redisService.publishLog(roomId, testLog);

    // Wait for message to be received
    await new Promise(resolve => setTimeout(resolve, 100));

    // Verify
    expect(receivedLogs).toHaveLength(1);
    expect(receivedLogs[0].message).toBe(testLog.message);

    // Cleanup
    await unsubscribe();
    */
  });
});
