// Generated by Kiro
import { Injectable, NotFoundException } from '@nestjs/common';
import { AgentType } from '@prisma/client';

import { PrismaService } from '../../prisma/prisma.service';

@Injectable()
export class AssetsService {
  constructor(private prisma: PrismaService) {}

  /**
   * List assets with optional filtering
   * Requirements: 10.1, 10.2
   */
  async findAll(filters?: { agentType?: AgentType; roomId?: string; limit?: number; offset?: number }) {
    const where: any = {};

    if (filters?.agentType) {
      where.agentType = filters.agentType;
    }

    if (filters?.roomId) {
      where.roomId = filters.roomId;
    }

    const assets = await this.prisma.asset.findMany({
      where,
      include: {
        room: {
          include: {
            owner: {
              select: {
                id: true,
                username: true,
                did: true,
              },
            },
          },
        },
      },
      orderBy: {
        createdAt: 'desc',
      },
      take: filters?.limit || 50,
      skip: filters?.offset || 0,
    });

    return assets;
  }

  /**
   * Get asset by ID
   * Requirements: 10.2
   */
  async findOne(id: string) {
    const asset = await this.prisma.asset.findUnique({
      where: { id },
      include: {
        room: {
          include: {
            owner: {
              select: {
                id: true,
                username: true,
                did: true,
              },
            },
          },
        },
      },
    });

    if (!asset) {
      throw new NotFoundException(`Asset with ID ${id} not found`);
    }

    return asset;
  }

  /**
   * Public content discovery with pagination
   * Requirements: 10.1, 10.2
   */
  async explore(filters?: { agentType?: AgentType; page?: number; pageSize?: number }) {
    const page = filters?.page || 1;
    const pageSize = filters?.pageSize || 20;
    const skip = (page - 1) * pageSize;

    const where: any = {};

    if (filters?.agentType) {
      where.agentType = filters.agentType;
    }

    const [assets, total] = await Promise.all([
      this.prisma.asset.findMany({
        where,
        include: {
          room: {
            select: {
              id: true,
              inputText: true,
              owner: {
                select: {
                  username: true,
                  did: true,
                },
              },
            },
          },
        },
        orderBy: {
          createdAt: 'desc',
        },
        take: pageSize,
        skip,
      }),
      this.prisma.asset.count({ where }),
    ]);

    return {
      data: assets,
      pagination: {
        page,
        pageSize,
        total,
        totalPages: Math.ceil(total / pageSize),
      },
    };
  }

  /**
   * Create asset (used by agents)
   * Requirements: 7.3
   */
  async create(data: {
    roomId: string;
    agentType: AgentType;
    cid: string;
    fileType?: string;
    fileSize?: bigint;
    metadata?: any;
  }) {
    const asset = await this.prisma.asset.create({
      data: {
        roomId: data.roomId,
        agentType: data.agentType,
        cid: data.cid,
        fileType: data.fileType,
        fileSize: data.fileSize ? Number(data.fileSize) : null,
        metadata: data.metadata,
      },
      include: {
        room: {
          include: {
            owner: {
              select: {
                id: true,
                username: true,
                did: true,
              },
            },
          },
        },
      },
    });

    return asset;
  }
}
