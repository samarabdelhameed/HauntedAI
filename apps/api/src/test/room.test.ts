// Generated by Kiro
import { prisma, cleanDatabase, closeDatabaseConnection, createTestUser } from './setup';

describe('Room CRUD Operations', () => {
  beforeEach(async () => {
    await cleanDatabase();
  });

  afterAll(async () => {
    await closeDatabaseConnection();
  });

  describe('Create Room', () => {
    it('should create a new room with idle status', async () => {
      const user = await createTestUser();

      const room = await prisma.room.create({
        data: {
          ownerId: user.id,
          inputText: 'Generate a spooky story about ghosts',
          status: 'idle',
        },
      });

      expect(room.id).toBeDefined();
      expect(room.ownerId).toBe(user.id);
      expect(room.status).toBe('idle');
      expect(room.inputText).toBe('Generate a spooky story about ghosts');
      expect(room.createdAt).toBeInstanceOf(Date);
    });

    it('should create multiple rooms for same user', async () => {
      const user = await createTestUser();

      const room1 = await prisma.room.create({
        data: {
          ownerId: user.id,
          inputText: 'Story 1',
          status: 'idle',
        },
      });

      const room2 = await prisma.room.create({
        data: {
          ownerId: user.id,
          inputText: 'Story 2',
          status: 'idle',
        },
      });

      expect(room1.id).not.toBe(room2.id);
      expect(room1.ownerId).toBe(room2.ownerId);
    });
  });

  describe('Read Room', () => {
    it('should find room by ID', async () => {
      const user = await createTestUser();
      const created = await prisma.room.create({
        data: {
          ownerId: user.id,
          inputText: 'Test',
          status: 'idle',
        },
      });

      const found = await prisma.room.findUnique({
        where: { id: created.id },
      });

      expect(found).toBeDefined();
      expect(found?.id).toBe(created.id);
    });

    it('should find rooms by owner', async () => {
      const user = await createTestUser();

      await prisma.room.createMany({
        data: [
          { ownerId: user.id, inputText: 'Room 1', status: 'idle' },
          { ownerId: user.id, inputText: 'Room 2', status: 'done' },
          { ownerId: user.id, inputText: 'Room 3', status: 'running' },
        ],
      });

      const rooms = await prisma.room.findMany({
        where: { ownerId: user.id },
      });

      expect(rooms).toHaveLength(3);
    });

    it('should find rooms by status', async () => {
      const user = await createTestUser();

      await prisma.room.createMany({
        data: [
          { ownerId: user.id, inputText: 'Room 1', status: 'idle' },
          { ownerId: user.id, inputText: 'Room 2', status: 'done' },
          { ownerId: user.id, inputText: 'Room 3', status: 'idle' },
        ],
      });

      const idleRooms = await prisma.room.findMany({
        where: { status: 'idle' },
      });

      expect(idleRooms).toHaveLength(2);
      expect(idleRooms.every((r) => r.status === 'idle')).toBe(true);
    });
  });

  describe('Update Room', () => {
    it('should update room status from idle to running', async () => {
      const user = await createTestUser();
      const room = await prisma.room.create({
        data: {
          ownerId: user.id,
          inputText: 'Test',
          status: 'idle',
        },
      });

      const updated = await prisma.room.update({
        where: { id: room.id },
        data: { status: 'running' },
      });

      expect(updated.status).toBe('running');
    });

    it('should update room status from running to done', async () => {
      const user = await createTestUser();
      const room = await prisma.room.create({
        data: {
          ownerId: user.id,
          inputText: 'Test',
          status: 'running',
        },
      });

      const updated = await prisma.room.update({
        where: { id: room.id },
        data: { status: 'done' },
      });

      expect(updated.status).toBe('done');
    });

    it('should update room status to error', async () => {
      const user = await createTestUser();
      const room = await prisma.room.create({
        data: {
          ownerId: user.id,
          inputText: 'Test',
          status: 'running',
        },
      });

      const updated = await prisma.room.update({
        where: { id: room.id },
        data: { status: 'error' },
      });

      expect(updated.status).toBe('error');
    });
  });

  describe('Delete Room', () => {
    it('should delete room', async () => {
      const user = await createTestUser();
      const room = await prisma.room.create({
        data: {
          ownerId: user.id,
          inputText: 'Test',
          status: 'idle',
        },
      });

      await prisma.room.delete({
        where: { id: room.id },
      });

      const found = await prisma.room.findUnique({
        where: { id: room.id },
      });

      expect(found).toBeNull();
    });
  });
});
