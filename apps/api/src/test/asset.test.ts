// Generated by Kiro
import {
  prisma,
  cleanDatabase,
  closeDatabaseConnection,
  createTestUser,
  createTestRoom,
} from './setup';

describe('Asset CRUD Operations', () => {
  beforeEach(async () => {
    await cleanDatabase();
  });

  afterAll(async () => {
    await closeDatabaseConnection();
  });

  describe('Create Asset', () => {
    it('should create a story asset', async () => {
      const user = await createTestUser();
      const room = await createTestRoom(user.id);

      const asset = await prisma.asset.create({
        data: {
          roomId: room.id,
          agentType: 'story',
          cid: 'bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi',
          fileType: 'text/plain',
          fileSize: BigInt(1024),
          metadata: { title: 'Spooky Story' },
        },
      });

      expect(asset.id).toBeDefined();
      expect(asset.roomId).toBe(room.id);
      expect(asset.agentType).toBe('story');
      expect(asset.cid).toMatch(/^bafy/);
    });

    it('should create an image asset', async () => {
      const user = await createTestUser();
      const room = await createTestRoom(user.id);

      const asset = await prisma.asset.create({
        data: {
          roomId: room.id,
          agentType: 'asset',
          cid: 'bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi',
          fileType: 'image/png',
          fileSize: BigInt(2048),
        },
      });

      expect(asset.agentType).toBe('asset');
      expect(asset.fileType).toBe('image/png');
    });

    it('should create multiple assets for same room', async () => {
      const user = await createTestUser();
      const room = await createTestRoom(user.id);

      const story = await prisma.asset.create({
        data: {
          roomId: room.id,
          agentType: 'story',
          cid: 'bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi',
          fileType: 'text/plain',
          fileSize: BigInt(1024),
        },
      });

      const image = await prisma.asset.create({
        data: {
          roomId: room.id,
          agentType: 'asset',
          cid: 'bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi',
          fileType: 'image/png',
          fileSize: BigInt(2048),
        },
      });

      expect(story.id).not.toBe(image.id);
      expect(story.roomId).toBe(image.roomId);
    });
  });

  describe('Read Asset', () => {
    it('should find asset by ID', async () => {
      const user = await createTestUser();
      const room = await createTestRoom(user.id);

      const created = await prisma.asset.create({
        data: {
          roomId: room.id,
          agentType: 'story',
          cid: 'bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi',
          fileType: 'text/plain',
          fileSize: BigInt(1024),
        },
      });

      const found = await prisma.asset.findUnique({
        where: { id: created.id },
      });

      expect(found).toBeDefined();
      expect(found?.id).toBe(created.id);
    });

    it('should find assets by room', async () => {
      const user = await createTestUser();
      const room = await createTestRoom(user.id);

      await prisma.asset.createMany({
        data: [
          {
            roomId: room.id,
            agentType: 'story',
            cid: 'bafy1',
            fileType: 'text/plain',
            fileSize: BigInt(1024),
          },
          {
            roomId: room.id,
            agentType: 'asset',
            cid: 'bafy2',
            fileType: 'image/png',
            fileSize: BigInt(2048),
          },
        ],
      });

      const assets = await prisma.asset.findMany({
        where: { roomId: room.id },
      });

      expect(assets).toHaveLength(2);
    });

    it('should find assets by agent type', async () => {
      const user = await createTestUser();
      const room1 = await createTestRoom(user.id);
      const room2 = await createTestRoom(user.id);

      await prisma.asset.createMany({
        data: [
          {
            roomId: room1.id,
            agentType: 'story',
            cid: 'bafy1',
            fileType: 'text/plain',
            fileSize: BigInt(1024),
          },
          {
            roomId: room2.id,
            agentType: 'story',
            cid: 'bafy2',
            fileType: 'text/plain',
            fileSize: BigInt(1024),
          },
          {
            roomId: room1.id,
            agentType: 'asset',
            cid: 'bafy3',
            fileType: 'image/png',
            fileSize: BigInt(2048),
          },
        ],
      });

      const storyAssets = await prisma.asset.findMany({
        where: { agentType: 'story' },
      });

      expect(storyAssets).toHaveLength(2);
      expect(storyAssets.every((a) => a.agentType === 'story')).toBe(true);
    });

    it('should find asset by CID', async () => {
      const user = await createTestUser();
      const room = await createTestRoom(user.id);
      const cid = 'bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi';

      await prisma.asset.create({
        data: {
          roomId: room.id,
          agentType: 'story',
          cid,
          fileType: 'text/plain',
          fileSize: BigInt(1024),
        },
      });

      const found = await prisma.asset.findFirst({
        where: { cid },
      });

      expect(found).toBeDefined();
      expect(found?.cid).toBe(cid);
    });
  });

  describe('Delete Asset', () => {
    it('should delete asset', async () => {
      const user = await createTestUser();
      const room = await createTestRoom(user.id);

      const asset = await prisma.asset.create({
        data: {
          roomId: room.id,
          agentType: 'story',
          cid: 'bafy1',
          fileType: 'text/plain',
          fileSize: BigInt(1024),
        },
      });

      await prisma.asset.delete({
        where: { id: asset.id },
      });

      const found = await prisma.asset.findUnique({
        where: { id: asset.id },
      });

      expect(found).toBeNull();
    });

    it('should cascade delete assets when room is deleted', async () => {
      const user = await createTestUser();
      const room = await createTestRoom(user.id);

      const asset = await prisma.asset.create({
        data: {
          roomId: room.id,
          agentType: 'story',
          cid: 'bafy1',
          fileType: 'text/plain',
          fileSize: BigInt(1024),
        },
      });

      await prisma.room.delete({
        where: { id: room.id },
      });

      const foundAsset = await prisma.asset.findUnique({
        where: { id: asset.id },
      });

      expect(foundAsset).toBeNull();
    });
  });
});
