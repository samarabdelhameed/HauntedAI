# CodeAgent - HauntedAI

**Managed by Kiro** | Mini-Game Code Generation Service

## Overview

CodeAgent is a micro-service that generates spooky mini-game code using Google Gemini Pro. It takes a story and image theme as input, generates HTML/JavaScript code, tests it for security issues, auto-patches errors, and uploads the final code to Storacha/IPFS.

## Features

- ğŸ® **Code Generation**: Creates complete HTML/JS mini-games using Google Gemini Pro
- ğŸ”’ **Security Testing**: Validates code for dangerous patterns (eval, inline handlers)
- ğŸ”§ **Auto-Patching**: Automatically fixes errors up to 3 times
- ğŸ“¦ **Storacha Integration**: Uploads code to decentralized storage
- âœ… **Code Validation**: Runs security and syntax checks on generated JavaScript

## API Endpoints

### Health Check

```bash
GET /health
```

Response:
```json
{
  "status": "ok",
  "service": "code-agent",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### Generate Code

```bash
POST /generate
Content-Type: application/json

{
  "story": "A spooky story about ghosts...",
  "imageTheme": "haunted mansion",
  "roomId": "optional-room-id"
}
```

Response:
```json
{
  "code": "<!DOCTYPE html><html>...</html>",
  "cid": "bafybeig...",
  "tested": true,
  "patchAttempts": 1
}
```

## Environment Variables

```bash
# Required
GEMINI_API_KEY=your_gemini_api_key

# Optional
PORT=3004
NODE_ENV=development
SERVICE_NAME=code-agent
```

## Installation

```bash
# Install dependencies
npm install

# Build
npm run build

# Run in development
npm run dev

# Run in production
npm start
```

## Testing

```bash
# Run all tests
npm test

# Run with coverage
npm run test:coverage

# Run in watch mode
npm run test:watch
```

## Code Generation Process

1. **Receive Request**: Story + image theme
2. **Generate Code**: Call Google Gemini Pro with spooky game prompt
3. **Test Code**: Run security and syntax checks
4. **Auto-Patch**: If tests fail, generate patch (up to 3 attempts)
5. **Upload**: Upload final code to Storacha
6. **Return**: Return code + CID

## Security Checks

The service validates generated code for:
- âŒ `eval()` usage
- âŒ `Function()` constructor
- âŒ Inline event handlers (`onclick=`, etc.)
- âœ… ESLint rules compliance

## Example Usage

```typescript
const response = await fetch('http://localhost:3004/generate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    story: 'A ghost haunts an old mansion...',
    imageTheme: 'spooky mansion with fog',
  }),
});

const result = await response.json();
console.log('Generated code CID:', result.cid);
```

## Architecture

```
CodeAgent
â”œâ”€â”€ Express Server (Port 3004)
â”œâ”€â”€ CodeService
â”‚   â”œâ”€â”€ generateCode()
â”‚   â”œâ”€â”€ testCode()
â”‚   â””â”€â”€ generatePatch()
â”œâ”€â”€ StorachaClient
â”‚   â””â”€â”€ uploadFile()
â””â”€â”€ Security Validator
```

## Error Handling

- **Gemini API Failures**: Returns 500 with error message
- **Validation Failures**: Auto-patches up to 3 times
- **Upload Failures**: Retries with exponential backoff (3 attempts)

## Correctness Properties

This service implements the following correctness properties from the design document:

- **Property 9**: Image completion triggers code generation
- **Property 10**: Generated code is tested
- **Property 11**: Code storage round-trip

## Integration

CodeAgent is triggered by the Orchestrator after AssetAgent completes image generation. It receives the story and image theme, generates code, and returns the CID for deployment.

---

**Generated by Kiro** | HauntedAI Platform | Hackathon 2024
