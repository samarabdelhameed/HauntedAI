# CodeAgent - HauntedAI

**Managed by Kiro** | Mini-Game Code Generation Service

## Overview

CodeAgent is a micro-service that generates spooky mini-game code using **HuggingFace CodeLlama (FREE!)**. It takes a story and image theme as input, generates HTML/JavaScript code, tests it for security issues, auto-patches errors, and uploads the final code to Storacha/IPFS.

### ğŸ‰ Why HuggingFace?
- âœ… **100% FREE** - 30,000 requests/day
- âœ… **No Credit Card** - Just email signup
- âœ… **No Quota Issues** - Much higher limits
- âœ… **CodeLlama Model** - Specialized for code generation

## Features

- ğŸ® **Code Generation**: Creates complete HTML/JS mini-games using HuggingFace CodeLlama (FREE!)
- ğŸ”’ **Security Testing**: Validates code for dangerous patterns (eval, inline handlers)
- ğŸ”§ **Auto-Patching**: Automatically fixes errors up to 3 times
- ğŸ“¦ **Storacha Integration**: Uploads code to decentralized storage
- âœ… **Code Validation**: Runs security and syntax checks on generated JavaScript
- ğŸ”„ **Smart Retry**: 5 attempts with exponential backoff
- âš¡ **Model Loading**: Automatic wait when model is loading

## API Endpoints

### Health Check

```bash
GET /health
```

Response:
```json
{
  "status": "ok",
  "service": "code-agent",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### Generate Code

```bash
POST /generate
Content-Type: application/json

{
  "story": "A spooky story about ghosts...",
  "imageTheme": "haunted mansion",
  "roomId": "optional-room-id"
}
```

Response:
```json
{
  "code": "<!DOCTYPE html><html>...</html>",
  "cid": "bafybeig...",
  "tested": true,
  "patchAttempts": 1
}
```

## Environment Variables

```bash
# Required (FREE - Get from https://huggingface.co/settings/tokens)
HUGGINGFACE_API_KEY=hf_your_token_here

# Optional
PORT=3004
NODE_ENV=development
SERVICE_NAME=code-agent
```

### How to Get FREE HuggingFace Token:
1. Visit: https://huggingface.co/join
2. Sign up with email (no credit card!)
3. Go to: https://huggingface.co/settings/tokens
4. Click "New token" and copy it
5. Add to `.env` file

## Installation

```bash
# Install dependencies
npm install

# Build
npm run build

# Run in development
npm run dev

# Run in production
npm start
```

## Testing

```bash
# Run all tests
npm test

# Run with coverage
npm run test:coverage

# Run in watch mode
npm run test:watch
```

## Code Generation Process

1. **Receive Request**: Story + image theme
2. **Generate Code**: Call HuggingFace CodeLlama with spooky game prompt
3. **Test Code**: Run security and syntax checks
4. **Auto-Patch**: If tests fail, generate patch (up to 3 attempts)
5. **Upload**: Upload final code to Storacha
6. **Return**: Return code + CID

### Smart Retry Logic:
- 5 retry attempts with exponential backoff
- Automatic wait when model is loading (503 errors)
- Rate limit handling (429 errors)
- Network error recovery

## Security Checks

The service validates generated code for:
- âŒ `eval()` usage
- âŒ `Function()` constructor
- âŒ Inline event handlers (`onclick=`, etc.)
- âœ… ESLint rules compliance

## Example Usage

```typescript
const response = await fetch('http://localhost:3004/generate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    story: 'A ghost haunts an old mansion...',
    imageTheme: 'spooky mansion with fog',
  }),
});

const result = await response.json();
console.log('Generated code CID:', result.cid);
```

## Architecture

```
CodeAgent
â”œâ”€â”€ Express Server (Port 3004)
â”œâ”€â”€ CodeService
â”‚   â”œâ”€â”€ generateCode()
â”‚   â”œâ”€â”€ testCode()
â”‚   â””â”€â”€ generatePatch()
â”œâ”€â”€ StorachaClient
â”‚   â””â”€â”€ uploadFile()
â””â”€â”€ Security Validator
```

## Error Handling

- **HuggingFace API Failures**: Returns 500 with error message
- **Model Loading (503)**: Automatic wait and retry
- **Rate Limiting (429)**: Exponential backoff retry
- **Validation Failures**: Auto-patches up to 3 times
- **Upload Failures**: Retries with exponential backoff (3 attempts)

## API Limits (FREE Tier)

**HuggingFace Free Tier** (CodeLlama):
- âœ… **30,000 requests per day** (20x more than Gemini!)
- âœ… **3,000 requests per hour**
- âœ… **10 concurrent requests**
- âœ… **No credit card required**
- âœ… **No quota exceeded issues**

## Correctness Properties

This service implements the following correctness properties from the design document:

- **Property 9**: Image completion triggers code generation
- **Property 10**: Generated code is tested
- **Property 11**: Code storage round-trip

## Integration

CodeAgent is triggered by the Orchestrator after AssetAgent completes image generation. It receives the story and image theme, generates code, and returns the CID for deployment.

---

**Generated by Kiro** | HauntedAI Platform | Hackathon 2024
