// Generated by Kiro - Express server for StoryAgent
import express, { Request, Response, NextFunction } from 'express';
import cors from 'cors';
import { StoryService } from './story.service';
import {
  StoryGenerationRequest,
  StoryGenerationResponse,
  HealthCheckResponse,
  ErrorResponse,
} from './types';

export class StoryAgentServer {
  private app: express.Application;
  private storyService: StoryService;
  private port: number;

  constructor(apiKey: string, port: number = 3002) {
    this.app = express();
    this.port = port;
    this.storyService = new StoryService(apiKey);
    this.setupMiddleware();
    this.setupRoutes();
    this.setupErrorHandling();
  }

  private setupMiddleware(): void {
    this.app.use(cors());
    this.app.use(express.json());
    this.app.use(express.urlencoded({ extended: true }));

    // Request logging
    this.app.use((req: Request, res: Response, next: NextFunction) => {
      console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);
      next();
    });
  }

  private setupRoutes(): void {
    // Health check endpoint
    this.app.get('/health', async (req: Request, res: Response) => {
      try {
        const openaiHealthy = await this.storyService.checkHealth();

        const response: HealthCheckResponse = {
          status: openaiHealthy ? 'ok' : 'error',
          service: 'story-agent',
          timestamp: new Date().toISOString(),
          openai: {
            connected: openaiHealthy,
          },
        };

        res.status(openaiHealthy ? 200 : 503).json(response);
      } catch (error) {
        const response: HealthCheckResponse = {
          status: 'error',
          service: 'story-agent',
          timestamp: new Date().toISOString(),
          openai: {
            connected: false,
          },
        };
        res.status(503).json(response);
      }
    });

    // Story generation endpoint
    this.app.post('/generate', async (req: Request, res: Response, next: NextFunction) => {
      try {
        const request: StoryGenerationRequest = {
          input: req.body.input,
          userId: req.body.userId,
          roomId: req.body.roomId,
        };

        console.log(`Generating story for input: "${request.input?.substring(0, 50)}..."`);

        const response: StoryGenerationResponse = await this.storyService.generateStory(request);

        console.log(
          `Story generated successfully (${response.metadata.wordCount} words)`
        );

        res.status(200).json(response);
      } catch (error) {
        next(error);
      }
    });

    // Root endpoint
    this.app.get('/', (req: Request, res: Response) => {
      res.json({
        service: 'story-agent',
        version: '1.0.0',
        status: 'running',
        endpoints: {
          health: 'GET /health',
          generate: 'POST /generate',
        },
      });
    });
  }

  private setupErrorHandling(): void {
    // 404 handler
    this.app.use((req: Request, res: Response) => {
      const error: ErrorResponse = {
        error: 'Not Found',
        message: `Route ${req.method} ${req.path} not found`,
        statusCode: 404,
        timestamp: new Date().toISOString(),
      };
      res.status(404).json(error);
    });

    // Global error handler
    this.app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
      console.error('Error:', err);

      const statusCode = (err as any).statusCode || 500;
      const error: ErrorResponse = {
        error: err.name || 'Internal Server Error',
        message: err.message || 'An unexpected error occurred',
        statusCode,
        timestamp: new Date().toISOString(),
      };

      res.status(statusCode).json(error);
    });
  }

  public start(): void {
    this.app.listen(this.port, () => {
      console.log(`ğŸƒ StoryAgent service running on port ${this.port}`);
      console.log(`ğŸ“ Health check: http://localhost:${this.port}/health`);
      console.log(`ğŸ“ Generate story: POST http://localhost:${this.port}/generate`);
    });
  }

  public getApp(): express.Application {
    return this.app;
  }
}
