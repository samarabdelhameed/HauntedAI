// Generated by Kiro - Storacha client for DeployAgent
import { create } from '@web3-storage/w3up-client';
import type { Client } from '@web3-storage/w3up-client';

export class StorachaClient {
  private client: Client | null = null;
  private readonly maxRetries = 3;
  private readonly initialDelay = 2000;
  private readonly backoffMultiplier = 2;

  /**
   * Initialize Storacha client
   */
  async initialize(): Promise<void> {
    if (this.client) {
      return; // Already initialized
    }

    try {
      console.log('Initializing Storacha client...');
      this.client = await create();
      console.log('Storacha client initialized successfully');
    } catch (error) {
      console.error('Failed to initialize Storacha client:', error);
      throw error;
    }
  }

  /**
   * Retrieve file from IPFS using CID
   * @param cid - Content Identifier
   * @returns File content as string
   */
  async retrieveFile(cid: string): Promise<string> {
    return this.executeWithRetry(async () => {
      if (!this.client) {
        await this.initialize();
      }

      console.log(`Retrieving file from IPFS with CID: ${cid}`);

      // Fetch from IPFS gateway
      const gatewayUrl = `https://w3s.link/ipfs/${cid}`;
      const response = await fetch(gatewayUrl);

      if (!response.ok) {
        throw new Error(`Failed to fetch from IPFS: ${response.statusText}`);
      }

      const content = await response.text();
      console.log(`File retrieved successfully (${content.length} bytes)`);

      return content;
    });
  }

  /**
   * Execute operation with exponential backoff retry logic
   */
  private async executeWithRetry<T>(operation: () => Promise<T>): Promise<T> {
    let lastError: Error | null = null;

    for (let attempt = 0; attempt < this.maxRetries; attempt++) {
      try {
        return await operation();
      } catch (error) {
        lastError = error as Error;

        if (attempt < this.maxRetries - 1) {
          const delay = Math.min(
            this.initialDelay * Math.pow(this.backoffMultiplier, attempt),
            30000
          );

          console.warn(
            `Operation failed (attempt ${attempt + 1}/${this.maxRetries}), ` +
              `retrying in ${delay}ms: ${lastError.message}`
          );

          await this.sleep(delay);
        }
      }
    }

    console.error(`Operation failed after ${this.maxRetries} attempts: ${lastError?.message}`);
    throw lastError;
  }

  /**
   * Sleep utility for retry delays
   */
  private sleep(ms: number): Promise<void> {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }

  /**
   * Validate CID format
   */
  validateCID(cid: string): boolean {
    const cidPattern = /^bafy[a-z2-7]{55,}$/;
    return cidPattern.test(cid);
  }
}
