// Generated by Kiro - DeployAgent Server
import express, { Request, Response, NextFunction } from 'express';
import cors from 'cors';
import { DeployService } from './deploy.service';
import { AgentMetrics } from '@hauntedai/shared';
import type { DeployRequest } from './types';

export class DeployAgentServer {
  private app: express.Application;
  private deployService: DeployService;
  private metrics: AgentMetrics;
  private port: number;

  constructor(port: number = 3005) {
    this.app = express();
    this.port = port;
    this.deployService = new DeployService();
    this.metrics = new AgentMetrics('deploy');
    this.setupMiddleware();
    this.setupRoutes();
    this.setupErrorHandling();
  }

  private setupMiddleware(): void {
    this.app.use(cors());
    this.app.use(express.json({ limit: '10mb' }));

    // Request logging and metrics
    this.app.use((req: Request, res: Response, next: NextFunction) => {
      const startTime = Date.now();
      console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);
      
      res.on('finish', () => {
        const duration = (Date.now() - startTime) / 1000;
        this.metrics.recordHttpRequest(req.method, req.path, res.statusCode, duration);
      });
      
      next();
    });
  }

  private setupRoutes(): void {

    // Health check endpoint
    this.app.get('/health', async (req: Request, res: Response) => {
      try {
        const health = await this.deployService.healthCheck();
        res.json(health);
      } catch (error) {
        res.status(500).json({
          status: 'error',
          error: error instanceof Error ? error.message : 'Unknown error',
        });
      }
    });

    // Deploy endpoint
    this.app.post('/deploy', async (req: Request, res: Response, next: NextFunction) => {
      const startTime = Date.now();
      try {
        const { codeCid, roomId, projectName } = req.body as DeployRequest;

        // Validate required fields
        if (!codeCid || !roomId) {
          return res.status(400).json({
            success: false,
            error: 'Missing required fields: codeCid and roomId are required',
          });
        }

        console.log(`Received deployment request for room ${roomId} with CID: ${codeCid}`);

        // Execute deployment
        const result = await this.deployService.deploy({
          codeCid,
          roomId,
          projectName,
        });

        const duration = (Date.now() - startTime) / 1000;
        
        if (result.success) {
          this.metrics.recordExecution('deploy', 'success', duration);
          res.status(200).json(result);
        } else {
          this.metrics.recordExecution('deploy', 'failure', duration);
          this.metrics.recordFailure('deploy', 'DeploymentError');
          res.status(500).json(result);
        }
      } catch (error) {
        const duration = (Date.now() - startTime) / 1000;
        this.metrics.recordExecution('deploy', 'failure', duration);
        this.metrics.recordFailure('deploy', error.name || 'UnknownError');
        next(error);
      }
    });

    // Metrics endpoint
    this.app.get('/metrics', async (req: Request, res: Response) => {
      try {
        const metrics = await this.metrics.getMetrics();
        res.set('Content-Type', this.metrics.getContentType());
        res.send(metrics);
      } catch (error) {
        res.status(500).json({ error: 'Failed to get metrics' });
      }
    });

    // Root endpoint
    this.app.get('/', (req: Request, res: Response) => {
      res.json({
        service: 'deploy-agent',
        version: '1.0.0',
        status: 'running',
        endpoints: {
          health: 'GET /health',
          deploy: 'POST /deploy',
          metrics: 'GET /metrics',
        },
      });
    });
  }

  private setupErrorHandling(): void {
    // 404 handler
    this.app.use((req: Request, res: Response) => {
      res.status(404).json({
        error: 'Not Found',
        message: `Route ${req.method} ${req.path} not found`,
        statusCode: 404,
        timestamp: new Date().toISOString(),
      });
    });

    // Global error handler
    this.app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
      console.error('Error:', err);

      const statusCode = (err as any).statusCode || 500;
      res.status(statusCode).json({
        error: err.name || 'Internal Server Error',
        message: err.message || 'An unexpected error occurred',
        statusCode,
        timestamp: new Date().toISOString(),
      });
    });
  }

  public start(): void {
    this.app.listen(this.port, () => {
      console.log(`ğŸš€ DeployAgent server running on port ${this.port}`);
      console.log(`ğŸ“ Health check: http://localhost:${this.port}/health`);
      console.log(`ğŸ“ Deploy: POST http://localhost:${this.port}/deploy`);
    });
  }

  public getApp(): express.Application {
    return this.app;
  }
}

export default DeployAgentServer;
