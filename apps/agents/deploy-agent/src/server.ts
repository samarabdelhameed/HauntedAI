// Generated by Kiro - DeployAgent Server
import express, { Request, Response } from 'express';
import cors from 'cors';
import { DeployService } from './deploy.service';
import type { DeployRequest } from './types';

const app = express();
const deployService = new DeployService();

// Middleware
app.use(cors());
app.use(express.json({ limit: '10mb' }));

// Request logging middleware
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
  next();
});

/**
 * Health check endpoint
 * GET /health
 */
app.get('/health', async (req: Request, res: Response) => {
  try {
    const health = await deployService.healthCheck();
    res.json(health);
  } catch (error) {
    res.status(500).json({
      status: 'error',
      error: error instanceof Error ? error.message : 'Unknown error',
    });
  }
});

/**
 * Deploy endpoint
 * POST /deploy
 * Body: { codeCid: string, roomId: string, projectName?: string }
 */
app.post('/deploy', async (req: Request, res: Response) => {
  try {
    const { codeCid, roomId, projectName } = req.body as DeployRequest;

    // Validate required fields
    if (!codeCid || !roomId) {
      return res.status(400).json({
        success: false,
        error: 'Missing required fields: codeCid and roomId are required',
      });
    }

    console.log(`Received deployment request for room ${roomId} with CID: ${codeCid}`);

    // Execute deployment
    const result = await deployService.deploy({
      codeCid,
      roomId,
      projectName,
    });

    if (result.success) {
      res.status(200).json(result);
    } else {
      res.status(500).json(result);
    }
  } catch (error) {
    console.error('Deployment error:', error);
    res.status(500).json({
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
  }
});

/**
 * Root endpoint
 */
app.get('/', (req: Request, res: Response) => {
  res.json({
    service: 'DeployAgent',
    version: '1.0.0',
    status: 'running',
    endpoints: {
      health: 'GET /health',
      deploy: 'POST /deploy',
    },
  });
});

// Error handling middleware
app.use((err: Error, req: Request, res: Response, next: Function) => {
  console.error('Unhandled error:', err);
  res.status(500).json({
    success: false,
    error: err.message || 'Internal server error',
  });
});

export default app;
