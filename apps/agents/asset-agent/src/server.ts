// Generated by Kiro - Express server for AssetAgent
import express, { Request, Response, NextFunction } from 'express';
import cors from 'cors';
import { AssetService } from './asset.service';
import {
  AssetGenerationRequest,
  AssetGenerationResponse,
  HealthCheckResponse,
  ErrorResponse,
} from './types';

export class AssetAgentServer {
  private app: express.Application;
  private assetService: AssetService;
  private port: number;

  constructor(apiKey: string, port: number = 3003) {
    this.app = express();
    this.port = port;
    this.assetService = new AssetService(apiKey);
    this.setupMiddleware();
    this.setupRoutes();
    this.setupErrorHandling();
  }

  private setupMiddleware(): void {
    this.app.use(cors());
    this.app.use(express.json({ limit: '10mb' })); // Increased limit for story content
    this.app.use(express.urlencoded({ extended: true, limit: '10mb' }));

    // Request logging
    this.app.use((req: Request, res: Response, next: NextFunction) => {
      console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);
      next();
    });
  }

  private setupRoutes(): void {
    // Health check endpoint
    this.app.get('/health', async (req: Request, res: Response) => {
      try {
        const openaiHealthy = await this.assetService.checkHealth();

        const response: HealthCheckResponse = {
          status: 'ok', // Service is always ok if it's running
          service: 'asset-agent',
          timestamp: new Date().toISOString(),
          openai: {
            connected: openaiHealthy,
          },
        };

        res.status(200).json(response); // Always return 200 if service is running
      } catch (error) {
        const response: HealthCheckResponse = {
          status: 'ok', // Service is ok, just OpenAI is not connected
          service: 'asset-agent',
          timestamp: new Date().toISOString(),
          openai: {
            connected: false,
          },
        };
        res.status(200).json(response); // Return 200 even if OpenAI check fails
      }
    });

    // Asset generation endpoint
    this.app.post('/generate', async (req: Request, res: Response, next: NextFunction) => {
      try {
        // Validate required fields
        if (!req.body.story || typeof req.body.story !== 'string' || req.body.story.trim().length === 0) {
          const error: ErrorResponse = {
            error: 'Validation Error',
            message: 'story is required and must be a non-empty string',
            statusCode: 400,
            timestamp: new Date().toISOString(),
          };
          return res.status(400).json(error);
        }

        if (!req.body.userId || typeof req.body.userId !== 'string') {
          const error: ErrorResponse = {
            error: 'Validation Error',
            message: 'userId is required and must be a string',
            statusCode: 400,
            timestamp: new Date().toISOString(),
          };
          return res.status(400).json(error);
        }

        if (!req.body.roomId || typeof req.body.roomId !== 'string') {
          const error: ErrorResponse = {
            error: 'Validation Error',
            message: 'roomId is required and must be a string',
            statusCode: 400,
            timestamp: new Date().toISOString(),
          };
          return res.status(400).json(error);
        }

        const request: AssetGenerationRequest = {
          story: req.body.story,
          storySummary: req.body.storySummary,
          userId: req.body.userId,
          roomId: req.body.roomId,
        };

        console.log(`Generating asset for story (${request.story?.length || 0} chars)...`);

        const response: AssetGenerationResponse = await this.assetService.generateAsset(request);

        console.log(
          `Asset generated successfully (${response.metadata.size} bytes, CID: ${response.imageCid})`
        );

        res.status(200).json(response);
      } catch (error) {
        next(error);
      }
    });

    // Root endpoint
    this.app.get('/', (req: Request, res: Response) => {
      res.json({
        service: 'asset-agent',
        version: '1.0.0',
        status: 'running',
        endpoints: {
          health: 'GET /health',
          generate: 'POST /generate',
        },
      });
    });
  }

  private setupErrorHandling(): void {
    // 404 handler
    this.app.use((req: Request, res: Response) => {
      const error: ErrorResponse = {
        error: 'Not Found',
        message: `Route ${req.method} ${req.path} not found`,
        statusCode: 404,
        timestamp: new Date().toISOString(),
      };
      res.status(404).json(error);
    });

    // Global error handler
    this.app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
      console.error('Error:', err);

      const statusCode = (err as any).statusCode || 500;
      const error: ErrorResponse = {
        error: err.name || 'Internal Server Error',
        message: err.message || 'An unexpected error occurred',
        statusCode,
        timestamp: new Date().toISOString(),
      };

      res.status(statusCode).json(error);
    });
  }

  public start(): void {
    this.app.listen(this.port, () => {
      console.log(`ğŸƒ AssetAgent service running on port ${this.port}`);
      console.log(`ğŸ“ Health check: http://localhost:${this.port}/health`);
      console.log(`ğŸ“ Generate asset: POST http://localhost:${this.port}/generate`);
    });
  }

  public getApp(): express.Application {
    return this.app;
  }
}
