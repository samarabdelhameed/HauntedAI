# End-to-End Testing Guide

**Generated by Kiro** | HauntedAI Platform Testing Documentation

## Overview

This guide explains how to run and understand the end-to-end user scenario tests for HauntedAI. These tests simulate a complete user journey through the platform.

## Test Scenario

The E2E test simulates the following user journey:

```
1. Health Check â†’ Verify API is running
2. Create Room â†’ User creates a new session
3. Get Room Details â†’ Verify room was created
4. Start Workflow â†’ Trigger agent workflow
5. Monitor Logs â†’ Connect to SSE and watch real-time logs
6. Verify Status â†’ Check final room status
```

## Running the Test

### Prerequisites

- API server running on `http://localhost:3001`
- PostgreSQL database running
- Redis server running

### Start Services

```bash
# Start all services with Docker
docker-compose -f docker-compose.dev.yml up -d

# Or start API manually
cd apps/api
npm run dev
```

### Run E2E Test

```bash
# From project root
node apps/api/test-e2e-user-scenario.js

# Or from apps/api directory
node test-e2e-user-scenario.js
```

## Expected Output

```
ðŸŽƒ HauntedAI - End-to-End User Scenario Test ðŸŽƒ

============================================================

ðŸ“‹ Step 1: Health Check
âœ“ API is healthy

ðŸ“‹ Step 2: Create New Room
âœ“ Room created successfully
  Room ID: room-1733058123456-abc
  Status: idle
  Input: Tell me a spooky story about a haunted mansion

ðŸ“‹ Step 3: Get Room Details
âœ“ Room details retrieved
  Owner: test-user-1733058123456
  Created: 2024-12-01T10:15:23.456Z

ðŸ“‹ Step 4: Start Workflow
âœ“ Workflow started
  Status: running
  Message: Workflow started successfully

ðŸ“‹ Step 5: Monitor Live Logs (SSE)
Connecting to SSE stream...
âœ“ SSE connection established
  Connected to room: room-1733058123456-abc
  [INFO] orchestrator: Starting workflow for room room-1733058123456-abc
  [INFO] story: Starting story generation
  [SUCCESS] story: Story generated successfully (2.5s)
  â™¥ Heartbeat
  [INFO] story: Uploading to Storacha
  [SUCCESS] story: Story uploaded with CID: bafybeig...

âœ“ Received 6 log messages

ðŸ“‹ Step 6: Verify Final Room Status
âœ“ Final room status retrieved
  Status: running
  Assets: 0

============================================================
ðŸŽ‰ User Scenario Test Completed Successfully! ðŸŽ‰
============================================================

Test Summary:
  âœ“ Room created: room-1733058123456-abc
  âœ“ Workflow started
  âœ“ SSE connection established
  âœ“ Logs received: 6
  âœ“ All steps passed
```

## Test Components

### 1. Health Check

Verifies the API is running and responsive:

```javascript
const health = await makeRequest('GET', '/health');
// Expected: { status: 'ok', timestamp: '...' }
```

### 2. Room Creation

Creates a new room with user input:

```javascript
const createResponse = await makeRequest('POST', '/api/v1/rooms', {
  userId: 'test-user-123',
  inputText: 'Tell me a spooky story about a haunted mansion'
});
// Expected: { id: '...', status: 'idle', ... }
```

### 3. Workflow Start

Triggers the agent workflow:

```javascript
const startWorkflow = await makeRequest('POST', `/api/v1/rooms/${roomId}/start`);
// Expected: { status: 'running', message: 'Workflow started successfully' }
```

### 4. SSE Connection

Connects to Server-Sent Events stream and monitors logs:

```javascript
const logs = await connectSSE(roomId);
// Receives real-time log messages:
// - event: connected
// - event: log (multiple)
// - event: heartbeat
```

### 5. Status Verification

Checks final room status after workflow:

```javascript
const finalRoom = await makeRequest('GET', `/api/v1/rooms/${roomId}`);
// Expected: { status: 'done' | 'running' | 'error', assets: [...] }
```

## SSE Event Types

The test monitors these SSE events:

### Connected Event

```json
{
  "event": "connected",
  "data": {
    "roomId": "room-123",
    "timestamp": "2024-12-01T10:15:23.456Z"
  }
}
```

### Log Event

```json
{
  "event": "log",
  "data": {
    "timestamp": "2024-12-01T10:15:24.123Z",
    "agentType": "story",
    "level": "info",
    "message": "Starting story generation",
    "metadata": {}
  }
}
```

### Heartbeat Event

```json
{
  "event": "heartbeat",
  "data": {
    "timestamp": "2024-12-01T10:15:53.456Z"
  }
}
```

## Troubleshooting

### API Not Running

**Error**: `ECONNREFUSED`

**Solution**:
```bash
# Check if API is running
curl http://localhost:3001/health

# Start API if not running
cd apps/api
npm run dev
```

### Database Connection Error

**Error**: `Database connection failed`

**Solution**:
```bash
# Check PostgreSQL is running
docker ps | grep postgres

# Start PostgreSQL
docker-compose -f docker-compose.dev.yml up -d postgres

# Run migrations
cd apps/api
npm run db:migrate
```

### Redis Connection Error

**Error**: `Redis connection failed`

**Solution**:
```bash
# Check Redis is running
docker ps | grep redis

# Start Redis
docker-compose -f docker-compose.dev.yml up -d redis
```

### SSE Connection Timeout

**Error**: `SSE connection failed: timeout`

**Solution**:
- Check if Redis is running (SSE uses Redis pub/sub)
- Verify room ID is correct
- Check API logs for errors

## Customizing the Test

### Change Test Input

Edit the `createRoomData` in the test file:

```javascript
const createRoomData = {
  userId: TEST_USER_ID,
  inputText: 'Your custom spooky prompt here',
};
```

### Adjust SSE Timeout

Change the SSE connection timeout (default 5 seconds):

```javascript
setTimeout(() => {
  req.destroy();
  resolve(logs);
}, 10000); // 10 seconds
```

### Add Custom Assertions

Add your own verification steps:

```javascript
// After Step 6
log('\nðŸ“‹ Step 7: Custom Verification', 'blue');
const customCheck = await makeRequest('GET', '/api/v1/custom-endpoint');
if (customCheck.status === 200) {
  log('âœ“ Custom check passed', 'green');
}
```

## Integration with CI/CD

### GitHub Actions

```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  e2e:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Run migrations
        run: cd apps/api && npm run db:migrate
      
      - name: Start API
        run: cd apps/api && npm run dev &
      
      - name: Wait for API
        run: sleep 10
      
      - name: Run E2E tests
        run: node apps/api/test-e2e-user-scenario.js
```

## Performance Benchmarks

Expected performance metrics:

| Step | Expected Time | Acceptable Range |
|------|--------------|------------------|
| Health Check | < 50ms | 10-100ms |
| Create Room | < 200ms | 100-500ms |
| Get Room Details | < 100ms | 50-300ms |
| Start Workflow | < 200ms | 100-500ms |
| SSE Connection | < 100ms | 50-200ms |
| Log Emission | < 100ms | 50-200ms |
| **Total Test** | **< 10s** | **5-15s** |

## Best Practices

### 1. Clean Up Test Data

Always clean up test data after running:

```javascript
// Add cleanup step
async function cleanup(roomId) {
  await makeRequest('DELETE', `/api/v1/rooms/${roomId}`);
}
```

### 2. Use Unique Test IDs

Generate unique IDs for each test run:

```javascript
const TEST_USER_ID = 'test-user-' + Date.now();
```

### 3. Handle Timeouts Gracefully

Set appropriate timeouts for long-running operations:

```javascript
const timeout = 30000; // 30 seconds for workflow completion
```

### 4. Log Detailed Information

Include detailed logging for debugging:

```javascript
log(`Request: ${method} ${path}`, 'cyan');
log(`Response: ${JSON.stringify(response, null, 2)}`, 'cyan');
```

### 5. Verify All Responses

Check status codes and response structure:

```javascript
if (response.status !== 200) {
  throw new Error(`Unexpected status: ${response.status}`);
}

if (!response.data.id) {
  throw new Error('Missing room ID in response');
}
```

## Related Documentation

- [SSE Implementation Standards](.kiro/steering/sse-implementation-standards.md)
- [Testing Standards](.kiro/steering/testing-standards.md)
- [Architecture Guidelines](.kiro/steering/architecture-guidelines.md)
- [API Documentation](http://localhost:3001/api/docs)

---

**Generated by Kiro** | HauntedAI Platform | Hackathon 2024
