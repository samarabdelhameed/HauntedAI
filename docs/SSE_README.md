# Server-Sent Events (SSE) Implementation

**Generated by Kiro** - Part of HauntedAI real-time logging system

## Overview

This implementation provides real-time log streaming for room operations using Server-Sent Events (SSE) and Redis pub/sub.

## Requirements

- **5.1**: Agent operations emit logs via SSE
- **5.2**: Log messages display with timestamp and agent type

## Architecture

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   Client    │◄────────│  SSE Service │◄────────│   Redis     │
│  (Browser)  │   SSE   │   (NestJS)   │  Pub/Sub│  (Message)  │
└─────────────┘         └──────────────┘         └─────────────┘
                                                         ▲
                                                         │
                                                         │
                                                  ┌──────┴──────┐
                                                  │   Agents    │
                                                  │ (Publish)   │
                                                  └─────────────┘
```

## Components

### 1. RedisService (`redis.service.ts`)
- Manages Redis pub/sub connections
- Publishes log messages to room channels
- Subscribes to room log channels
- Auto-reconnection with exponential backoff

### 2. SSEService (`sse.service.ts`)
- Creates SSE connections for clients
- Streams logs from Redis to clients
- Manages connection lifecycle
- Implements heartbeat (every 30s)

### 3. RoomsController (`rooms.controller.ts`)
- Exposes SSE endpoint: `GET /api/v1/rooms/:id/logs`
- Authenticates requests via JWT
- Verifies room exists before streaming

## Usage

### Client-Side (JavaScript)

```javascript
const eventSource = new EventSource(
  'http://localhost:3001/api/v1/rooms/ROOM_ID/logs',
  {
    headers: {
      Authorization: `Bearer ${jwtToken}`
    }
  }
);

// Connection established
eventSource.addEventListener('connected', (event) => {
  const data = JSON.parse(event.data);
  console.log('Connected to room:', data.roomId);
});

// Log message received
eventSource.addEventListener('log', (event) => {
  const log = JSON.parse(event.data);
  console.log(`[${log.timestamp}] ${log.agentType} - ${log.level}: ${log.message}`);
});

// Heartbeat (keep-alive)
eventSource.addEventListener('heartbeat', (event) => {
  const data = JSON.parse(event.data);
  console.log('Heartbeat:', data.timestamp);
});

// Handle errors
eventSource.onerror = (error) => {
  console.error('SSE error:', error);
  eventSource.close();
};

// Close connection
eventSource.close();
```

### Server-Side (Publishing Logs)

```typescript
// From any service with access to RoomsService
await this.roomsService.emitLog(
  roomId,
  'story',           // agentType
  'info',            // level: 'info' | 'warn' | 'error' | 'success'
  'Starting story generation',
  { userId: 'user-123' }  // optional metadata
);
```

## Log Message Format

```typescript
interface AgentLog {
  timestamp: Date;
  agentType: 'story' | 'asset' | 'code' | 'deploy' | 'orchestrator';
  level: 'info' | 'warn' | 'error' | 'success';
  message: string;
  metadata?: Record<string, any>;
}
```

## SSE Events

| Event | Description | Data |
|-------|-------------|------|
| `connected` | Connection established | `{ roomId, timestamp }` |
| `log` | Agent log message | `AgentLog` object |
| `heartbeat` | Keep-alive ping | `{ timestamp }` |

## Connection Management

- **Heartbeat**: Sent every 30 seconds to keep connection alive
- **Auto-cleanup**: Connections automatically closed on client disconnect
- **Error handling**: Graceful error handling with logging
- **Redis reconnection**: Automatic reconnection with exponential backoff

## Testing

```bash
# Test SSE endpoint with curl
curl -N -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  http://localhost:3001/api/v1/rooms/ROOM_ID/logs

# Expected output:
event: connected
data: {"roomId":"ROOM_ID","timestamp":"2024-01-01T00:00:00.000Z"}

event: log
data: {"timestamp":"2024-01-01T00:00:01.000Z","agentType":"story","level":"info","message":"Starting story generation"}

event: heartbeat
data: {"timestamp":"2024-01-01T00:00:30.000Z"}
```

## Environment Variables

```env
REDIS_URL=redis://localhost:6379
```

## Installation

```bash
cd apps/api
npm install ioredis
npm install --save-dev @types/ioredis
```

## Kiro Integration

This implementation is fully managed by Kiro:
- ✅ Generated from Kiro specs
- ✅ Follows HauntedAI design document
- ✅ Implements requirements 5.1 and 5.2
- ✅ Ready for property-based testing

## Next Steps

1. Install dependencies: `npm install ioredis`
2. Start Redis: `docker-compose up redis`
3. Test SSE endpoint
4. Integrate with Orchestrator service (Task 5)
5. Add property tests (Task 2.7)
